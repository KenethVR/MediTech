<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MediTech</title>
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="icon" href="/img/logo.png">
    </head>
    <body
        style="background: linear-gradient(to right, #e0f7fa, #ffffff); min-height: 100vh;">
        <div th:replace="fragments/navbar/navbar :: navbar"></div>

        <div class="container my-5">

            <h2 class="text-center mb-4 fw-bold text-primary">MediTech - Sistema
                de Gestión Hospitalaria</h2>
            <div class="card shadow-lg border-0 rounded-4 mt-5">
                <div class="card-header bg-primary text-white rounded-top-4">
                    <h5 class="mb-0">Registrar Nuevo Paciente</h5>
                </div>
                <div class="card-body">
                    <form id="formRegistrarPaciente">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="nombre"
                                    class="form-label">Nombre</label>
                                <input type="text" class="form-control"
                                    id="nombre" placeholder="Ej. Juan">
                            </div>
                            <div class="col-md-4">
                                <label for="apellido1"
                                    class="form-label">Primer Apellido</label>
                                <input type="text" class="form-control"
                                    id="apellido1" placeholder="Ej. Pérez">
                            </div>
                            <div class="col-md-4">
                                <label for="apellido2"
                                    class="form-label">Segundo Apellido</label>
                                <input type="text" class="form-control"
                                    id="apellido2" placeholder="Ej. Rodríguez">
                            </div>
                            <div class="col-md-6">
                                <label for="cedula"
                                    class="form-label">Cédula</label>
                                <input type="text" class="form-control"
                                    id="cedula" placeholder="Ej. 123456789">
                            </div>
                            <div class="col-md-6">
                                <label for="fechaNacimiento"
                                    class="form-label">Fecha de
                                    Nacimiento</label>
                                <input type="date" class="form-control"
                                    id="fechaNacimiento">
                            </div>
                            <div class="col-md-3">
                                <label for="sexo"
                                    class="form-label">Sexo</label>
                                <select class="form-select" id="sexo">
                                    <option selected
                                        disabled>Seleccione</option>
                                    <option>Masculino</option>
                                    <option>Femenino</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="urgenciaClinica"
                                    class="form-label">Urgencia Clínica</label>
                                <select class="form-select"
                                    id="urgenciaClinica">
                                    <option selected
                                        disabled>Seleccione</option>
                                    <option>URGENTE</option>
                                    <option>CRITICO</option>
                                    <option>GRAVE</option>
                                    <option>OBSERVACION</option>
                                    <option>ESTABLE</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label for="direccion"
                                    class="form-label">Dirección</label>
                                <input type="text" class="form-control"
                                    id="direccion">
                            </div>
                            <div class="col-md-6">
                                <label for="contactoEmergencia"
                                    class="form-label">Contacto de
                                    Emergencia</label>
                                <input type="text" class="form-control"
                                    id="contactoEmergencia">
                            </div>
                            <div class="col-md-6">
                                <label for="telefonoEmergencia"
                                    class="form-label">Teléfono de
                                    Emergencia</label>
                                <input type="text" class="form-control"
                                    id="telefonoEmergencia">
                            </div>
                            <div class="col-md-6">
                                <label for="telefono"
                                    class="form-label">Teléfono</label>
                                <input type="text" class="form-control"
                                    id="telefono">
                            </div>
                            <div class="col-md-6">
                                <label for="servicioHospital"
                                    class="form-label">Área Hospitalaria</label>
                                <select class="form-select"
                                    id="servicioHospital">
                                    <option value="0">No hay servicio
                                        asignado</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-end mt-4">
                            <button type="submit"
                                class="btn btn-primary rounded-pill px-4">Registrar
                                Paciente</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
    document.addEventListener("DOMContentLoaded", () => {
        // Cargar servicios hospitalarios primero
        fetch('/api/cargar/servicios')
            .then(res => res.json())
            .then(servicios => {
                const select = document.getElementById("servicioHospital");
                servicios.forEach(servicio => {
                    const option = document.createElement("option");
                    option.value = servicio.id;
                    option.textContent = servicio.descripcion;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error("Error cargando servicios:", error))
            .finally(() => {
                const getTrimmedValue = (id) => {
                    const el = document.getElementById(id);
                    if (!el) {
                        console.warn(`Elemento con id "${id}" no encontrado en el DOM.`);
                        return "";
                    }
                    if (typeof el.value !== "string") {
                        console.warn(`Elemento con id "${id}" no tiene una propiedad 'value' válida.`);
                        return "";
                    }
                    return el.value.trim();
                };

                // Definir el submit del formulario después de cargar los servicios
                document.getElementById("formRegistrarPaciente").addEventListener("submit", async function(e) {
                    e.preventDefault();

                    const nombre = getTrimmedValue("nombre");
                    const apellido1 = getTrimmedValue("apellido1");
                    const apellido2 = getTrimmedValue("apellido2");
                    const cedula = getTrimmedValue("cedula");
                    const fechaNacimiento = document.getElementById("fechaNacimiento").value;
                    const sexo = document.getElementById("sexo").value;
                    const urgenciaClinica = document.getElementById("urgenciaClinica").value;
                    const direccion = getTrimmedValue("direccion");
                    const contactoEmergencia = getTrimmedValue("contactoEmergencia");
                    const telefonoEmergencia = getTrimmedValue("telefonoEmergencia");
                    const telefono = getTrimmedValue("telefono");

                    // Bloque de depuración para verificar los valores extraídos
                    console.log({
                        nombre,
                        apellido1,
                        apellido2,
                        cedula,
                        direccion,
                        contactoEmergencia,
                        telefonoEmergencia,
                        telefono
                    });

                    if (!nombre || !apellido1 || !apellido2 || !cedula || !fechaNacimiento || !sexo || !urgenciaClinica || !direccion || !contactoEmergencia || !telefonoEmergencia || !telefono) {
                        Swal.fire({
                            icon: "warning",
                            title: "Campos incompletos",
                            text: "Por favor complete todos los campos."
                        });
                        return;
                    }

                    if (!/^\d{9}$/.test(cedula)) {
                        Swal.fire({
                            icon: "error",
                            title: "Cédula inválida",
                            text: "La cédula debe contener exactamente 9 dígitos numéricos."
                        });
                        return;
                    }

                    const fechaNacimientoDate = new Date(fechaNacimiento);
                    if (isNaN(fechaNacimientoDate.getTime())) {
                        Swal.fire({
                            icon: "error",
                            title: "Fecha de nacimiento inválida",
                            text: "Por favor ingrese una fecha válida."
                        });
                        return;
                    }

                    if (!/^\d{8,}$/.test(telefono)) {
                        Swal.fire({
                            icon: "error",
                            title: "Teléfono inválido",
                            text: "El teléfono debe contener al menos 8 dígitos numéricos."
                        });
                        return;
                    }

                    if (!/^\d{8,}$/.test(telefonoEmergencia)) {
                        Swal.fire({
                            icon: "error",
                            title: "Teléfono de emergencia inválido",
                            text: "El teléfono de emergencia debe contener al menos 8 dígitos numéricos."
                        });
                        return;
                    }

                    const pacienteData = {
                        nombre: nombre,
                        apellido1: apellido1,
                        apellido2: apellido2,
                        cedula: cedula,
                        fechaNacimiento: fechaNacimiento,
                        genero: sexo,
                        urgenciaClinica: urgenciaClinica,
                        direccion: direccion,
                        contactoEmergencia: contactoEmergencia,
                        telefonoEmergencia: telefonoEmergencia,
                        telefono: telefono,
                        servicioHospitalId: parseInt(document.getElementById("servicioHospital").value),
                    };

                    try {
                        const response = await fetch('/api/estructura/pacientes/agregar', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(pacienteData)
                        });

                        if (response.ok) {
                            Swal.fire({
                                icon: "success",
                                title: "Registro exitoso",
                                text: "Paciente registrado correctamente."
                            }).then(() => {
                                document.getElementById("formRegistrarPaciente").reset();
                            });
                        } else {
                            const errorData = await response.json();
                            Swal.fire({
                                icon: "error",
                                title: "Error al registrar",
                                text: errorData.message || "Ocurrió un error al registrar el paciente."
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: "error",
                            title: "Error de conexión",
                            text: "No se pudo conectar con el servidor."
                        });
                    }
                });
            });
    });
    </script>
    </body>

</html>