<!DOCTYPE html>
<html lang="es">
    <link rel="icon" href="/img/logo.png">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>MediTech - Traslado de Pacientes</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
            rel="stylesheet" />
        <!-- Bootstrap Icons -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
            rel="stylesheet" />
        <!-- SweetAlert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <style>
body {
  background: linear-gradient(to right, #e0f7fa, #ffffff);
  min-height: 100vh;
  
}

.header-title {
  margin-top: 50px;
  margin-bottom: 30px;
  font-weight: 700;
  color: #0d6efd;
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
  text-align: center;
  letter-spacing: 0.05em;
}

.container-main {
  max-width: 900px;
  background: white;
  padding: 30px 40px 40px 40px;
  margin: 0 auto 60px auto;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgb(0 0 0 / 0.1);
}

/* Cards grid for pacientes */
.row-cols-1 > .col, .row-cols-md-2 > .col {
  display: flex;
}

.card {
  border-radius: 12px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 30px rgba(13, 110, 253, 0.25);
}

.card-title {
  letter-spacing: 0.05em;
}

.btn-primary {
  border-radius: 50px;
  padding: 0.35rem 1rem;
  font-weight: 600;
  box-shadow: 0 4px 8px rgb(13 110 253 / 0.2);
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.btn-primary:hover {
  background-color: #0b5ed7;
  box-shadow: 0 6px 14px rgb(13 110 253 / 0.35);
}

.modal-content {
  border-radius: 15px;
  overflow: hidden;
}

.modal-header {
  background-color: #0d6efd;
  color: white;
  font-weight: 700;
  font-size: 1.25rem;
  letter-spacing: 0.02em;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-body label {
  font-weight: 600;
}

#resultado {
  font-size: 1.25rem;
  color: #198754;
  margin-top: 25px;
  text-align: center;
  font-weight: 600;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
        </style>
    </head>

    <body>
        <div th:replace="fragments/navbar/navbar :: navbar"></div>
        <div
            style="background: linear-gradient(to right, #e0f7fa, #ffffff); min-height: 100vh;">

            <div class="container-main">
                <h1 class="header-title">MediTech - Gestión de Traslado de
                    Pacientes</h1>

                <div class="row row-cols-1 row-cols-md-4 g-4"
                    id="pacientes-container">
                    <!-- Aquí se cargarán dinámicamente las cards -->
                </div>

                <!-- Modal para seleccionar nueva sala -->
                <div class="modal fade" id="modalTraslado" tabindex="-1"
                    aria-labelledby="modalTrasladoLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content border-0 shadow">
                            <div class="modal-header bg-primary text-white">
                                <h5
                                    class="modal-title d-flex align-items-center gap-2"
                                    id="modalTrasladoLabel">
                                    <i class="bi bi-person-arms-up"></i>
                                    Trasladar
                                    Paciente
                                </h5>
                                <button type="button"
                                    class="btn-close btn-close-white"
                                    data-bs-dismiss="modal"
                                    aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <p id="detallePaciente"
                                    class="fw-bold mb-3"></p>
                                <label for="nuevaSala" class="form-label">Nueva
                                    Sala</label>
                                <select class="form-select" id="nuevaSala">
                                    <option selected disabled>Seleccione sala
                                        destino</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button"
                                    class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                                <button type="button" class="btn btn-success"
                                    onclick="confirmarTraslado()">
                                    <i class="bi bi-check-circle-fill"></i>
                                    Confirmar Traslado
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="resultado"></div>
            </div>

            <!-- Bootstrap JS Bundle -->
            <script
                src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

            <!-- Script propio -->
            <script>
let pacientes = [];
let servicios = [];
let pacienteActual = null;
let habitacionActual = '';
let salaActualId = null;
let salaActualDescripcion = '';

const prioridades = {
  'URGENTE': 1,
  'CRITICO': 2,
  'GRAVE': 3,
  'OBSERVACION': 4,
  'ESTABLE': 5
};

document.addEventListener("DOMContentLoaded", async () => {
  try {
    const [pacientesRes, serviciosRes] = await Promise.all([
      fetch('/api/estructura/pacientes/listar'),
      fetch('/api/cargar/servicios')
    ]);
    pacientes = await pacientesRes.json();
    servicios = await serviciosRes.json();

    // Ordenar pacientes por prioridad clínica
    pacientes.sort((a, b) => {
      const prioridadA = prioridades[a.urgenciaClinica?.toUpperCase()] || 99;
      const prioridadB = prioridades[b.urgenciaClinica?.toUpperCase()] || 99;
      return prioridadA - prioridadB;
    });

    const container = document.getElementById('pacientes-container');
    container.innerHTML = '';

    if (pacientes.length === 0) {
      container.innerHTML = '<p class="text-center text-muted">No hay pacientes registrados.</p>';
      return;
    }

    pacientes.forEach((paciente, index) => {
      const servicio = servicios.find(s => s.id === paciente.servicioHospitalId);
      const descripcionServicio = servicio ? servicio.descripcion : 'No asignado';
      const habitacion = paciente.habitacion || `Habitación ${index + 100}`;

      const card = document.createElement('div');
      card.className = 'col';
      card.innerHTML = `
        <div class="card shadow-sm h-100 text-center">
          <div class="card-body d-flex flex-column justify-content-between">
            <div>
              <h5 class="card-title text-primary fw-bold">${paciente.nombre} ${paciente.apellido1} ${paciente.apellido2}</h5>
              <p class="card-text mb-1"><strong>Habitación:</strong> ${habitacion}</p>
              <p class="card-text"><strong>Sala Actual:</strong> ${descripcionServicio}</p>
              <p class="card-text"><strong>Prioridad Clínica:</strong> ${paciente.urgenciaClinica || 'N/A'}</p>
            </div>
            <button class="btn btn-primary align-self-start mt-3 mx-auto" onclick="abrirModal(${paciente.cedula})">
              <i class="bi bi-arrow-right-circle-fill me-2"></i>Trasladar
            </button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  } catch (error) {
    console.error('Error cargando pacientes o servicios:', error);
  }
});

async function abrirModal(cedulaPaciente) {
  pacienteActual = pacientes.find(p => p.cedula === cedulaPaciente);
  if (!pacienteActual) return;

  const servicio = servicios.find(s => s.id === pacienteActual.servicioHospitalId);
  salaActualId = servicio ? servicio.id : null;
  salaActualDescripcion = servicio ? servicio.descripcion : 'No asignado';

  habitacionActual = pacienteActual.habitacion || 'N/A';

  document.getElementById('detallePaciente').innerText = `Paciente: ${pacienteActual.nombre} ${pacienteActual.apellido1} ${pacienteActual.apellido2} - Habitación: ${habitacionActual} - Sala Actual: ${salaActualDescripcion}`;

  const select = document.getElementById('nuevaSala');
  select.innerHTML = '<option selected disabled>Seleccione sala destino</option>';
  servicios.forEach(s => {
    const option = document.createElement('option');
    option.value = s.id;
    option.textContent = s.descripcion;
    select.appendChild(option);
  });

  const modal = new bootstrap.Modal(document.getElementById('modalTraslado'));
  modal.show();
}

async function confirmarTraslado() {
  const nuevoServicioId = parseInt(document.getElementById('nuevaSala').value);
  if (!nuevoServicioId) {
    Swal.fire({
      icon: 'warning',
      title: 'Error',
      text: 'Debe seleccionar una sala destino.',
    });
    return;
  }
  if (nuevoServicioId === salaActualId) {
    Swal.fire({
      icon: 'info',
      title: 'Atención',
      text: 'El paciente ya se encuentra en esa sala.',
    });
    return;
  }

  try {
    // Obtener ruta detallada
    const rutaRes = await fetch(`/api/traslados/ruta/detallada?origen=${salaActualId}&destino=${nuevoServicioId}`);
    if (!rutaRes.ok) {
      throw new Error('No se pudo obtener la ruta detallada');
    }
    const ruta = await rutaRes.json();

    // Obtener colaboradores del servicio actual
    const colaboradoresRes = await fetch('/api/estructura/colaboradores/listar');
    if (!colaboradoresRes.ok) {
      throw new Error('No se pudo obtener la lista de colaboradores');
    }
    const colaboradores = await colaboradoresRes.json();

    // Filtrar colaboradores por servicio actual (areaServicio == salaActualId)
    const colaboradoresDelServicio = colaboradores.filter(colab => colab.areaServicio === salaActualId);
    let colaboradorResponsable = colaboradoresDelServicio.length > 0 ? colaboradoresDelServicio[0] : null;
    let nombreColaborador = colaboradorResponsable ? colaboradorResponsable.nombre : 'Colaborador asignado';

    // Mostrar ruta con colaborador en Swal y confirmación
    const rutaHtml = ruta.map(paso => `<li>${paso}</li>`).join('');
    const result = await Swal.fire({
      title: 'Ruta de traslado',
      html: `<p><strong>${nombreColaborador}</strong> traslada al paciente por:</p><ol style="text-align: left;">${rutaHtml}</ol>`,
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: 'Confirmar traslado',
      cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
      // Modificar paciente con nuevo servicioHospitalId
      pacienteActual.servicioHospitalId = nuevoServicioId;
      const response = await fetch('/api/estructura/pacientes/modificar', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(pacienteActual)
      });

      if (response.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Traslado exitoso',
          text: `Paciente ${pacienteActual.nombre} trasladado a ${servicios.find(s => s.id === nuevoServicioId).descripcion}.`
        });

        // Actualizar UI para reflejar cambio de sala
        await recargarPacientes();

        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalTraslado'));
        modal.hide();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'No se pudo completar el traslado.'
        });
      }
    }
  } catch (error) {
    console.error('Error en traslado:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Error al procesar el traslado.'
    });
  }
}

async function recargarPacientes() {
  try {
    const pacientesRes = await fetch('/api/estructura/pacientes/listar');
    pacientes = await pacientesRes.json();

    const container = document.getElementById('pacientes-container');
    container.innerHTML = '';

    pacientes.forEach((paciente, index) => {
      const servicio = servicios.find(s => s.id === paciente.servicioHospitalId);
      const descripcionServicio = servicio ? servicio.descripcion : 'No asignado';
      const habitacion = paciente.habitacion || `Habitación ${index + 100}`;

      const card = document.createElement('div');
      card.className = 'col';
      card.innerHTML = `
        <div class="card shadow-sm h-100 text-center">
          <div class="card-body d-flex flex-column justify-content-between">
            <div>
              <h5 class="card-title text-primary fw-bold">${paciente.nombre} ${paciente.apellido1} ${paciente.apellido2}</h5>
              <p class="card-text mb-1"><strong>Habitación:</strong> ${habitacion}</p>
              <p class="card-text"><strong>Sala Actual:</strong> ${descripcionServicio}</p>
            </div>
            <button class="btn btn-primary align-self-start mt-3 mx-auto" onclick="abrirModal(${paciente.cedula})">
              <i class="bi bi-arrow-right-circle-fill me-2"></i>Trasladar
            </button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  } catch (error) {
    console.error('Error recargando pacientes:', error);
  }
}
</script>
        </body>

    </html>