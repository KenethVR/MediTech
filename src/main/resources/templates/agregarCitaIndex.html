<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MediTech</title>
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="icon" href="/img/logo.png">
    </head>
    <body
        style="background: linear-gradient(to right, #e0f7fa, #ffffff); min-height: 100vh;">
        <div th:replace="fragments/navbar/navbar :: navbar"></div>

        <div class="container my-5 mb-auto">

            <h2 class="text-center mb-4 fw-bold text-primary">MediTech - Sistema
                de Gestión Hospitalaria</h2>
            <div class="card shadow-lg border-0 rounded-4 mt-5">
                <div class="card-header bg-primary text-white rounded-top-4">
                    <h5 class="mb-0">Registrar Nueva Cita</h5>
                </div>
                <div class="card-body">
                    <form id="formRegistrarCita">
                        <div class="mb-3">
                            <label for="pacienteInput"
                                class="form-label">Paciente</label>
                            <input type="text" class="form-control"
                                id="pacienteInput"
                                placeholder="Escriba el nombre del paciente"
                                autocomplete="off">
                            <ul class="list-group position-absolute z-3 w-100"
                                id="sugerenciasPacientes"
                                style="max-height: 150px; overflow-y: auto;"></ul>
                        </div>

                        <div class="mb-3">
                            <label for="servicio" class="form-label">Área de
                                Servicio</label>
                            <select class="form-select servicio" id="servicio">
                                <option selected disabled>Seleccione una
                                    opción</option>

                                <!-- Más opciones -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="motivoCita" class="form-label">Motivo de
                                la Cita</label>
                            <textarea class="form-control" id="motivoCita"
                                rows="3"
                                placeholder="Describa el motivo de la consulta"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="estadoClinico" class="form-label">Estado
                                Clínico</label>
                            <select class="form-select" id="estadoClinico">
                                <option selected disabled>Seleccione un estado
                                    clínico</option>
                                <option>URGENTE</option>
                                <option>CRITICO</option>
                                <option>GRAVE</option>
                                <option>OBSERVACION</option>
                                <option>ESTABLE</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="medicoSelect"
                                class="form-label">Médico</label>
                            <select class="form-select" id="medicoSelect">
                                <option selected disabled>Seleccione un
                                    médico</option>
                                <!-- Opciones de médicos serán llenadas dinámicamente -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="fechaHora" class="form-label">Fecha y
                                Hora</label>
                            <input type="datetime-local" class="form-control"
                                id="fechaHora">
                        </div>

                        <div class="text-end">
                            <button type="submit"
                                class="btn btn-primary rounded-pill px-4">Registrar
                                Cita</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
        // Helpers y referencias
        const inputPaciente = document.getElementById("pacienteInput");
        const listaSugerencias = document.getElementById("sugerenciasPacientes");
        const areaServicio = document.getElementById("servicio");
        const medicoSelect = document.getElementById("medicoSelect");
        const fechaHora = document.getElementById("fechaHora");
        const formRegistrarCita = document.getElementById("formRegistrarCita");

        let pacienteSeleccionado = null; // Guardará el objeto paciente seleccionado

        async function cargarServicios() {
            try {
                const res = await fetch('/api/cargar/servicios');
                if (!res.ok) throw new Error('No se pudo cargar servicios');
                const servicios = await res.json();
                const select = document.getElementById('servicio');
                select.innerHTML = '<option value disabled selected>Seleccione un servicio</option>';
                servicios.forEach(servicio => {
                    const option = document.createElement('option');
                    option.value = servicio.id;
                    option.textContent = servicio.descripcion;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar servicios:', error);
            }
        }

        // Autocompletar nombres de pacientes desde el backend
        async function fetchPacientes(nombre) {
            if (!nombre || nombre.trim() === "") return [];
            try {
                const resp = await fetch(`/api/estructura/pacientes/buscarNombre/${nombre}`);
                if (!resp.ok) return [];
                return await resp.json();
            } catch (e) {
                return [];
            }
        }

        inputPaciente.addEventListener("input", async () => {
            const valor = inputPaciente.value.trim();
            listaSugerencias.innerHTML = "";
            pacienteSeleccionado = null;
            if (valor === "") return;
            const sugerencias = await fetchPacientes(valor);
            sugerencias.forEach(paciente => {
                const item = document.createElement("li");
                item.classList.add("list-group-item", "list-group-item-action");
                item.textContent = paciente.nombre + " " + paciente.apellido1 + " " + paciente.apellido2;
                item.addEventListener("click", () => {
                    inputPaciente.value = paciente.nombre + " " + paciente.apellido1 + " " + paciente.apellido2;
                    pacienteSeleccionado = paciente;
                    listaSugerencias.innerHTML = "";
                }); 
                listaSugerencias.appendChild(item);
            });
        });

        // Validar que el nombre escrito es de un paciente válido
        async function validarPaciente() {
            // Si ya fue seleccionado de la lista, ok
            if (
                pacienteSeleccionado &&
                inputPaciente.value.trim() === `${pacienteSeleccionado.nombre} ${pacienteSeleccionado.apellido1} ${pacienteSeleccionado.apellido2}`
            ) {
                return pacienteSeleccionado;
            }
            // Buscar paciente exacto
            const nombre = inputPaciente.value.trim();
            if (!nombre) return null;
            const sugerencias = await fetchPacientes(nombre);
            const encontrado = sugerencias.find(p => p.nombre === nombre);
            if (encontrado) {
                pacienteSeleccionado = encontrado;
                return encontrado;
            }
            return null;
        }

        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener("click", (e) => {
            if (!inputPaciente.contains(e.target) && !listaSugerencias.contains(e.target)) {
                listaSugerencias.innerHTML = "";
            }
        });

        // Autocompletar médicos por servicio
        areaServicio.addEventListener("change", async () => {
            const servicioId = areaServicio.value;
            medicoSelect.innerHTML = '<option selected disabled>Seleccione un médico</option>';
            if (!servicioId) return;
            try {
                const resp = await fetch(`/api/estructura/medicos/buscarPorServicio/${encodeURIComponent(servicioId)}`);
                if (!resp.ok) throw new Error('No se pudo obtener médicos');
                const medicos = await resp.json();
                medicos.forEach(medico => {
                    const opt = document.createElement("option");
                    opt.value = medico.cedula; // Usamos la cédula como identificador
                    opt.textContent = `${medico.nombre} ${medico.apellidos}`;
                    medicoSelect.appendChild(opt);
                });
            } catch (e) {
                console.error("Error al cargar médicos:", e);
            }
        });
        // Validar disponibilidad de cita
        async function validarDisponibilidad(fechaHoraStr) {
            if (!fechaHoraStr) return false;
            try {
                // Asegurar formato ISO_LOCAL_DATE_TIME sin segundos
                const fecha = new Date(fechaHoraStr);
                const fechaLocal = fecha.toISOString().slice(0, 16); // "YYYY-MM-DDTHH:MM"
                const resp = await fetch(`/api/estructura/citas/disponibilidad?fecha=${encodeURIComponent(fechaLocal)}`);
                if (!resp.ok) return false;
                const data = await resp.json();
                return data.disponible === true;
            } catch (e) {
                return false;
            }
        }

        // SUBMIT FORM
        formRegistrarCita.addEventListener("submit", async (e) => {
            e.preventDefault();
            // Validar paciente
            const paciente = await validarPaciente();
            if (!paciente) {
                if (window.Swal) {
                    Swal.fire('Error', 'Debe seleccionar un paciente válido.', 'error');
                } else {
                    alert('Debe seleccionar un paciente válido.');
                }
                return;
            }
            // Validar médico
            const medicoId = medicoSelect.value;
            if (!medicoId || medicoId === "Seleccione un médico") {
                if (window.Swal) {
                    Swal.fire('Error', 'Debe seleccionar un médico.', 'error');
                } else {
                    alert('Debe seleccionar un médico.');
                }
                return;
            }
            // Validar fecha/hora
            const fechaHoraStr = fechaHora.value;
            if (!fechaHoraStr) {
                if (window.Swal) {
                    Swal.fire('Error', 'Debe seleccionar fecha y hora.', 'error');
                } else {
                    alert('Debe seleccionar fecha y hora.');
                }
                return;
            }
            // Validar disponibilidad
            const disponible = await validarDisponibilidad(fechaHoraStr);
            if (!disponible) {
                if (window.Swal) {
                    Swal.fire('Error', 'La fecha y hora seleccionadas no están disponibles.', 'error');
                } else {
                    alert('La fecha y hora seleccionadas no están disponibles.');
                }
                return;
            }
            // Validar estado clínico
            const estadoClinico = document.getElementById("estadoClinico").value;
            if (!estadoClinico || estadoClinico === "Seleccione un estado clínico") {
                if (window.Swal) {
                    Swal.fire('Error', 'Debe seleccionar un estado clínico.', 'error');
                } else {
                    alert('Debe seleccionar un estado clínico.');
                }
                return;
            }
            // Recolectar datos
            const datos = {
                motivoConsulta: document.getElementById("motivoCita").value,
                dictamenMedico: "", // inicial vacío
                estado: true, // activa por defecto
                fechaCita: fechaHoraStr,
                paciente: paciente.cedula,
                medico: medicoId,
                areaServicio: areaServicio.value,
                urgenciaClinica: estadoClinico
            };
            // Enviar datos
            try {
                const resp = await fetch('/api/estructura/citas/agregar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                if (resp.ok) {
                    if (window.Swal) {
                        await Swal.fire('Éxito', 'Cita registrada correctamente.', 'success');
                    } else {
                        alert('Cita registrada correctamente.');
                    }
                    formRegistrarCita.reset();
                    pacienteSeleccionado = null;
                    medicoSelect.innerHTML = '<option selected disabled>Seleccione un médico</option>';
                } else {
                    const err = await resp.json().catch(()=>{});
                    let msg = err && err.message ? err.message : 'Error al registrar la cita.';
                    if (window.Swal) {
                        Swal.fire('Error', msg, 'error');
                    } else {
                        alert(msg);
                    }
                }
            } catch (err) {
                if (window.Swal) {
                    Swal.fire('Error', 'No se pudo registrar la cita.', 'error');
                } else {
                    alert('No se pudo registrar la cita.');
                }
            }
        });
        window.addEventListener("DOMContentLoaded", cargarServicios);
        </script>
    </body>

</html>