<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MediTech</title>
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="icon" href="/img/logo.png">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>
    <body
        style="background: linear-gradient(to right, #e0f7fa, #ffffff); min-height: 100vh;">
        <div th:replace="fragments/navbar/navbar :: navbar"></div>

        <div class="container-fluid my-5">
            <h2 class="text-center mb-4 fw-bold text-primary">MediTech - Sistema
                de Gestión Hospitalaria</h2>
            <hr class="my-5">
            <h4 class="text-center text-secondary fw-semibold mb-4">Pacientes
                Registrados</h4>

            <div class="table-responsive">
                <table
                    class="table table-striped table-hover align-middle rounded-4 overflow-hidden shadow">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col">N.º</th>
                            <th scope="col">Cédula</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Apellidos</th>
                            <th scope="col">Edad</th>
                            <th scope="col">Genero</th>
                            <th scope="col">Dirección</th>
                            <th scope="col">Contacto Emergencia</th>
                            <th scope="col">Teléfono</th>
                            <th scope="col">Estado Clínico</th>
                            <th scope="col">Área de Hospitalaria</th>
                            <th scope="col">Administración</th>
                        </tr>
                    </thead>
                    <tbody id="tablaPacientes">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal Editar Paciente -->
        <div class="modal fade" id="modalEditarPaciente" tabindex="-1"
            aria-labelledby="modalEditarPacienteLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content rounded-4 shadow">
                    <div
                        class="modal-header bg-primary text-white rounded-top-4">
                        <h5 class="modal-title"
                            id="modalEditarPacienteLabel">Editar Información del
                            Paciente</h5>
                        <button type="button" class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formEditarPaciente">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control"
                                        id="editarNombre"
                                        placeholder="Ej. Juan">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Apellido 1</label>
                                    <input type="text" class="form-control"
                                        id="editarApellido1"
                                        placeholder="Ej. Pérez">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Apellido 2</label>
                                    <input type="text" class="form-control"
                                        id="editarApellido2"
                                        placeholder="Ej. Rodríguez">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Cédula</label>
                                    <input type="text" class="form-control"
                                        id="editarCedula"
                                        placeholder="Ej. 123456789" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fecha de
                                        Nacimiento</label>
                                    <input type="date" class="form-control"
                                        id="editarFechaNacimiento">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Edad</label>
                                    <input type="number" class="form-control"
                                        min="0" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Sexo</label>
                                    <select class="form-select"
                                        id="editarGenero">
                                        <option>Masculino</option>
                                        <option>Femenino</option>
                                        <option>Otro</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Teléfono</label>
                                    <input type="text" class="form-control"
                                        id="editarTelefono">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Teléfono
                                        Emergencia</label>
                                    <input type="text" class="form-control"
                                        id="editarTelefonoEmergencia">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Dirección</label>
                                    <input type="text" class="form-control"
                                        id="editarDireccion">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Contacto de
                                        Emergencia</label>
                                    <input type="text" class="form-control"
                                        id="editarContactoEmergencia">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Estado
                                        Clínico</label>
                                    <select class="form-select"
                                        id="editarUrgenciaClinica">
                                        <option>URGENTE</option>
                                        <option>CRITICO</option>
                                        <option>GRAVE</option>
                                        <option>OBSERVACION</option>
                                        <option>ESTABLE</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Área de
                                        Hospitalaria</label>
                                    <select class="form-select"
                                        id="editarServicioHospitalario">
                                        <option value="0">No hay servicio
                                            asignado</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button"
                                class="btn btn-secondary rounded-pill"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" form="formEditarPaciente"
                                class="btn btn-primary rounded-pill">Guardar
                                Cambios</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
            let serviciosHospital = [];
            function calcularEdad(fechaNacimiento) {
                const hoy = new Date();
                const nacimiento = new Date(fechaNacimiento);
                let edad = hoy.getFullYear() - nacimiento.getFullYear();
                const mes = hoy.getMonth() - nacimiento.getMonth();

                if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                    edad--;
                }

                return edad;
            }

            function obtenerPrioridad(urgencia) {
                const prioridades = {
                    "URGENTE": 1,
                    "CRITICO": 2,
                    "GRAVE": 3,
                    "OBSERVACION": 4,
                    "ESTABLE": 5
                };
                return prioridades[urgencia] || 99; // fallback si es desconocido
            }

            document.addEventListener("DOMContentLoaded", function () {
                // Cargar servicios hospitalarios en el select dinámicamente
                fetch('/api/cargar/servicios')
                    .then(res => res.json())
                    .then(servicios => {
                        serviciosHospital = servicios;
                        const select = document.getElementById("editarServicioHospitalario");
                        select.innerHTML = '<option value="0">No hay servicio asignado</option>';
                        servicios.forEach(servicio => {
                            const option = document.createElement("option");
                            option.value = servicio.id;
                            option.textContent = servicio.descripcion;    
                            select.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Error al cargar servicios:", error);
                    })
                    .finally(() => {
                        fetch('/api/estructura/pacientes/listar')
                            .then(response => response.json())
                            .then(data => {
                                const tbody = document.querySelector('#tablaPacientes');
                                tbody.innerHTML = ''; // Limpia la tabla
                                data.sort((a, b) => obtenerPrioridad(a.urgenciaClinica) - obtenerPrioridad(b.urgenciaClinica));

                                data.forEach((paciente, index) => {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `
                                        <th scope="row">${index + 1}</th>
                                        <td>${paciente.cedula}</td>
                                        <td>${paciente.nombre}</td>
                                        <td>${paciente.apellido1 + " " + paciente.apellido2}</td> <!-- Apellidos no disponibles en estructura -->
                                        <td>${calcularEdad(paciente.fechaNacimiento)}</td> <!-- Edad no disponible -->
                                        <td>${paciente.genero}</td> <!-- Sexo no disponible -->
                                        <td>${paciente.direccion}</td> <!-- Dirección no disponible -->
                                        <td>${paciente.contactoEmergencia}</td> <!-- Contacto emergencia no disponible -->
                                        <td>${paciente.telefonoEmergencia}</td> <!-- Teléfono no disponible -->
                                        <td>${paciente.urgenciaClinica}</td> <!-- Teléfono no disponible -->
                                        <td>${
                                            paciente.servicioHospitalId > 0
                                                ? (serviciosHospital.find(s => s.id === paciente.servicioHospitalId) ?.descripcion || "Desconocido")
                                                : "No asignado"
                                        }</td>
                                        <td>
                                            <button class="btn btn-warning btn-sm btn-editar" data-cedula="${paciente.cedula}">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                        </td>
                                    `;
                                    tbody.appendChild(tr);
                                });
                            })
                            .catch(error => console.error('Error al cargar pacientes:', error));
                    });
            });

            document.addEventListener("click", function (e) {
                const btn = e.target.closest(".btn-editar");
                if (!btn) return;

                const cedula = btn.dataset.cedula;

                fetch(`/api/estructura/pacientes/buscar/${cedula}`)
                    .then(res => {
                        if (!res.ok) throw new Error("Paciente no encontrado");
                        return res.json();
                    })
                    .then(paciente => {
                        document.getElementById("editarCedula").value = paciente.cedula;
                        document.getElementById("editarNombre").value = paciente.nombre;
                        document.getElementById("editarApellido1").value = paciente.apellido1;
                        document.getElementById("editarApellido2").value = paciente.apellido2;
                        document.getElementById("editarFechaNacimiento").value = paciente.fechaNacimiento.split('T')[0];
                        document.getElementById("editarGenero").value = paciente.genero;
                        document.getElementById("editarTelefono").value = paciente.telefono;
                        document.getElementById("editarTelefonoEmergencia").value = paciente.telefonoEmergencia;
                        document.getElementById("editarDireccion").value = paciente.direccion;
                        document.getElementById("editarContactoEmergencia").value = paciente.contactoEmergencia;
                        document.getElementById("editarUrgenciaClinica").value = paciente.urgenciaClinica;
                        document.getElementById("editarServicioHospitalario").value = paciente.servicioHospitalId;

                        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById("modalEditarPaciente"));
                        modal.show();
                    })
                    .catch(error => {
                        console.error("Error al cargar paciente:", error);
                        Swal.fire("Error", "No se pudo cargar el paciente", "error");
                    });
            });

            document.getElementById("formEditarPaciente").addEventListener("submit", function (e) {
                e.preventDefault();

                const paciente = {
                    cedula: parseInt(document.getElementById("editarCedula").value),
                    nombre: document.getElementById("editarNombre").value,
                    apellido1: document.getElementById("editarApellido1").value,
                    apellido2: document.getElementById("editarApellido2").value,
                    fechaNacimiento: document.getElementById("editarFechaNacimiento").value,
                    genero: document.getElementById("editarGenero").value,
                    telefono: document.getElementById("editarTelefono").value,
                    direccion: document.getElementById("editarDireccion").value,
                    contactoEmergencia: document.getElementById("editarContactoEmergencia").value,
                    telefonoEmergencia: document.getElementById("editarTelefonoEmergencia").value,
                    urgenciaClinica: document.getElementById("editarUrgenciaClinica").value,
                    estado: true,
                    servicioHospitalId: parseInt(document.getElementById("editarServicioHospitalario").value),
                };

                fetch("/api/estructura/pacientes/modificar", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(paciente)
                })
                    .then(res => res.text())
                    .then(msg => {
                        Swal.fire("Modificado", msg, "success").then(() => location.reload());
                    })
                    .catch(error => {
                        Swal.fire("Error", "No se pudo modificar el paciente", "error");
                        console.error(error);
                    });
            });
        </script>

        </body>

    </html>