<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MediTech</title>
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="icon" href="/img/logo.png">
    </head>
    <body
        style="background: linear-gradient(to right, #e0f7fa, #ffffff); min-height: 100vh;">
        <div th:replace="fragments/navbar/navbar :: navbar"></div>

        <div class="container my-5">
            <h2 class="text-center mb-4 fw-bold text-primary">MediTech - Sistema
                de Gestión Hospitalaria</h2>

            <!-- Mantenimiento de Médicos -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-semibold">Mantenimiento de Médicos</h4>
                <button class="btn btn-primary" data-bs-toggle="modal"
                    data-bs-target="#modalMedico">
                    Registrar Médico
                </button>
            </div>

            <div class="row" id="cardContainer">
                <!-- Tarjetas de médicos -->
            </div>

            <!-- Modal Registro Médico -->
            <div class="modal fade" id="modalMedico" tabindex="-1"
                aria-labelledby="modalMedicoLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content shadow">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"
                                id="modalMedicoLabel">Registrar Médico</h5>
                            <button type="button"
                                class="btn-close btn-close-white"
                                data-bs-dismiss="modal"></button>
                        </div>
                        <form id="formMedico">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="cedula"
                                        class="form-label">Cédula</label>
                                    <input type="text" class="form-control"
                                        id="cedula"
                                        pattern="^\d{9}$"
                                        maxlength="9"
                                        title="La cédula debe contener exactamente 9 dígitos numéricos"
                                        autocomplete="off"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="nombre"
                                        class="form-label">Nombre</label>
                                    <input type="text" class="form-control"
                                        id="nombre"
                                        pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
                                        title="El nombre debe contener solo letras y espacios"
                                        autocomplete="off"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="apellidos"
                                        class="form-label">Apellidos</label>
                                    <input type="text" class="form-control"
                                        id="apellidos"
                                        pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
                                        title="Los apellidos deben contener solo letras y espacios"
                                        autocomplete="off"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="fechaNacimiento"
                                        class="form-label">Fecha de
                                        Nacimiento</label>
                                    <input type="date" class="form-control"
                                        id="fechaNacimiento" required>
                                </div>
                                <div class="mb-3">
                                    <label for="especialidad"
                                        class="form-label">Especialidad</label>
                                    <input type="text" class="form-control"
                                        id="especialidad"
                                        pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
                                        title="La especialidad debe contener solo letras y espacios"
                                        autocomplete="off"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="sexo"
                                        class="form-label">Genero</label>
                                    <select class="form-select" id="sexo"
                                        required>
                                        <option value selected
                                            disabled>Seleccione</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Femenino</option>
                                        <option value="O">Otro</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="servicio"
                                        class="form-label">Servicio que
                                        brinda</label>
                                    <select class="form-select" id="servicio"
                                        required>
                                        <option value disabled
                                            selected>Seleccione un
                                            servicio</option>
                                    </select>
                                </div>
                                <!-- El campo "Activo" se elimina, los médicos se registran activos por defecto -->
                            </div>
                            <div class="modal-footer">
                                <button type="submit"
                                    class="btn btn-success">Guardar</button>
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Modificar Médico -->
            <div class="modal fade" id="modalModificarMedico" tabindex="-1"
                aria-labelledby="modalModificarMedicoLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content shadow">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"
                                id="modalModificarMedicoLabel">Modificar
                                Médico</h5>
                            <button type="button"
                                class="btn-close btn-close-white"
                                data-bs-dismiss="modal"></button>
                        </div>
                        <form id="formModificarMedico">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="modCedula"
                                        class="form-label">Cédula</label>
                                    <input type="text" class="form-control"
                                        id="modCedula"
                                        pattern="^\d{9}$"
                                        maxlength="9"
                                        title="La cédula debe contener exactamente 9 dígitos numéricos"
                                        autocomplete="off"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="modNombre"
                                        class="form-label">Nombre</label>
                                    <input type="text" class="form-control"
                                        id="modNombre"
                                        pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
                                        title="El nombre debe contener solo letras y espacios"
                                        autocomplete="off"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="modApellidos"
                                        class="form-label">Apellidos</label>
                                    <input type="text" class="form-control"
                                        id="modApellidos"
                                        pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
                                        title="Los apellidos deben contener solo letras y espacios"
                                        autocomplete="off"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="modFechaNacimiento"
                                        class="form-label">Fecha de
                                        Nacimiento</label>
                                    <input type="date" class="form-control"
                                        id="modFechaNacimiento" required>
                                </div>
                                <div class="mb-3">
                                    <label for="modEspecialidad"
                                        class="form-label">Especialidad</label>
                                    <input type="text" class="form-control"
                                        id="modEspecialidad"
                                        pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
                                        title="La especialidad debe contener solo letras y espacios"
                                        autocomplete="off"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="modSexo"
                                        class="form-label">Genero</label>
                                    <select class="form-select" id="modSexo"
                                        required>
                                        <option value selected
                                            disabled>Seleccione</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Femenino</option>
                                        <option value="O">Otro</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="modServicio"
                                        class="form-label">Servicio que
                                        brinda</label>
                                    <select class="form-select" id="modServicio"
                                        required>
                                        <option value disabled
                                            selected>Seleccione un
                                            servicio</option>
                                    </select>
                                </div>
                                <!-- El campo "Activo" se elimina, los médicos se registran activos por defecto -->
                            </div>
                            <div class="modal-footer">
                                <button type="submit"
                                    class="btn btn-success">Guardar
                                    Cambios</button>
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
        <script>
    const form = document.getElementById('formMedico');
    const formModificar = document.getElementById('formModificarMedico');
    const cardContainer = document.getElementById('cardContainer');

    // Cargar servicios dinámicamente
    async function cargarServicios() {
        const res = await fetch('/api/cargar/servicios');
        const servicios = await res.json();
        const selects = [document.getElementById('servicio'), document.getElementById('modServicio')];
        selects.forEach(select => {
            select.innerHTML = '<option value disabled selected>Seleccione un servicio</option>';
            servicios.forEach(servicio => {
                const option = document.createElement('option');
                option.value = servicio.id;
                option.textContent = servicio.descripcion;
                select.appendChild(option);
            });
        });
    }

    async function cargarServiciosModal(id) {
        const res = await fetch('/api/cargar/servicios');
        const servicios = await res.json();
        const servicio = servicios.find(serv => serv.id == id);
        return servicio ? servicio.descripcion : 'Servicio no encontrado';
    }

    // Crear card
    async function crearCard(medico) {
        const card = document.createElement('div');
        card.className = 'col-md-4 mb-4';

        let titulo = 'Dr.';
        if (medico.genero.toLowerCase() === 'f') titulo = 'Dra.';

        const nacimiento = new Date(medico.fechaNacimiento);
        const hoy = new Date();
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const m = hoy.getMonth() - nacimiento.getMonth();
        if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) edad--;

        let generoStr = 'Otro';
        if (medico.genero.toLowerCase() === 'm') generoStr = 'Masculino';
        else if (medico.genero.toLowerCase() === 'f') generoStr = 'Femenino';

        const descripcion = await cargarServiciosModal(medico.servicioHospitalId);

        card.innerHTML = `
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">${titulo} ${medico.nombre} ${medico.apellidos}</h5>
                    <p class="card-text mb-1"><strong>Cédula:</strong> ${medico.cedula}</p>
                    <p class="card-text mb-1"><strong>Género:</strong> ${generoStr}</p>
                    <p class="card-text mb-1"><strong>Edad:</strong> ${edad} años</p>
                    <p class="card-text mb-1"><strong>Especialidad:</strong> ${medico.especialidad}</p>
                    <p class="card-text mb-1"><strong>Servicio:</strong> ${descripcion}</p>
                    <div class="mt-3 d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-primary" onclick="abrirModalModificar(${medico.cedula})">Modificar</button>
                    </div>
                </div>
            </div>
        `;
        cardContainer.appendChild(card);
    }

    // Listar médicos
    async function listarMedicos() {
        const res = await fetch('/api/estructura/medicos/listar');
        const medicos = await res.json();
        cardContainer.innerHTML = '';
        for (const medico of medicos) {
            await crearCard(medico);
        }
    }

    // Agregar médico
    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const medico = {
            cedula: parseInt(document.getElementById('cedula').value),
            nombre: document.getElementById('nombre').value,
            apellidos: document.getElementById('apellidos').value,
            genero: document.getElementById('sexo').value,
            especialidad: document.getElementById('especialidad').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            servicioHospitalId: document.getElementById('servicio').value
        };

        await fetch('/api/estructura/medicos/agregar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(medico)
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('modalMedico'));
        modal.hide();
        form.reset();
        listarMedicos();
    });

    // Abrir modal y cargar datos
    async function abrirModalModificar(cedula) {
        const res = await fetch(`/api/estructura/medicos/buscar/${cedula}`);
        if (!res.ok) {
            alert('Error al buscar médico');
            return;
        }

        const medico = await res.json();
        document.getElementById('modCedula').value = medico.cedula;
        document.getElementById('modNombre').value = medico.nombre;
        document.getElementById('modApellidos').value = medico.apellidos;
        document.getElementById('modFechaNacimiento').value = medico.fechaNacimiento.split('T')[0];
        document.getElementById('modEspecialidad').value = medico.especialidad;
        document.getElementById('modSexo').value = medico.genero;
        document.getElementById('modServicio').value = medico.servicioHospitalId;

        const modal = new bootstrap.Modal(document.getElementById('modalModificarMedico'));
        modal.show();
    }

    // Modificar médico
    formModificar.addEventListener('submit', async function (e) {
        e.preventDefault();
        const medico = {
            cedula: parseInt(document.getElementById('modCedula').value),
            nombre: document.getElementById('modNombre').value,
            apellidos: document.getElementById('modApellidos').value,
            genero: document.getElementById('modSexo').value,
            especialidad: document.getElementById('modEspecialidad').value,
            fechaNacimiento: document.getElementById('modFechaNacimiento').value,
            servicioHospitalId: document.getElementById('modServicio').value
        };

        await fetch('/api/estructura/medicos/modificar', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(medico)
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('modalModificarMedico'));
        modal.hide();
        formModificar.reset();
        listarMedicos();
    });

    // Carga inicial
    document.addEventListener('DOMContentLoaded', () => {
        cargarServicios();
        listarMedicos();
    });
</script>
    </body>

</html>